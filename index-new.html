<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Игра</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="app" class="phone">
    <!-- Навигация -->
    <status-bar :time="time" :battery-level="batteryLevel"></status-bar>
    <navigation
      :active-screen="activeScreen"
      :current-lang="currentLang"
      @show-screen="showScreen"
      @toggle-language="toggleLanguage"
    ></navigation>

    <!-- Экраны -->
    <start-screen
      v-if="activeScreen === 'start'"
      :translations="translations"
      :current-lang="currentLang"
      @start-new-game="startNewGame"
    ></start-screen>

    <chat-screen
      v-if="activeScreen === 'chat'"
      :messages="messages"
      :choices="choices"
      :current-lang="currentLang"
      :show-chat-list="showChatList"
      :game-state="gameState"
      :translations="translations"
      :current-chat="currentChat"
      @toggle-chat-list="toggleChatList"
      @switch-chat="switchChat"
      @handle-choice="handleChoice"
      @open-fullscreen-image="openFullscreenImage"
    ></chat-screen>

    <puregram-screen
      v-if="activeScreen === 'puregram'"
      :posts="posts"
      :current-lang="currentLang"
      :current-chat="currentChat"
      @open-fullscreen-image="openFullscreenImage"
      @toggle-like="toggleLike"
    ></puregram-screen>

    <boosty-screen
      v-if="activeScreen === 'boosty'"
      :translations="translations"
      :current-lang="currentLang"
      @start-new-game="startNewGame"
    ></boosty-screen>

    <endgame-screen
      v-if="activeScreen === 'endgame'"
      :translations="translations"
      :current-lang="currentLang"
      @start-second-arc="startSecondArc"
    ></endgame-screen>
  </div>

  <script type="module">
    import { GameStateManager } from './src/GameStateManager.js';
    import { ChapterLoader } from './src/ChapterLoader.js';
    import { LanguageManager } from './src/LanguageManager.js';
    import { ScreenManager } from './src/ScreenManager.js';
    import { determineSecondArcStart, saveGameState, loadGameState } from './src/ArcManager.js';

    const { createApp, ref, computed } = Vue;

    // Инициализация модулей
    const gameStateManager = new GameStateManager();
    const screenManager = new ScreenManager(gameStateManager);
    const messageRenderer = {
      clearChat: () => {
        app.messages = [];
        app.choices = [];
      },
      addMessage: (type, text, src, description) => {
        app.messages.push({ type, text, src, description });
        app.scrollToBottom();
      },
      renderChoices: (choices) => {
        app.choices = choices;
        app.scrollToBottom();
      },
      chatContainer: { scrollTop: 0, scrollHeight: 0 }, // Переопределяется через ref
    };
    const chapterLoader = new ChapterLoader(messageRenderer, gameStateManager);
    const languageManager = new LanguageManager(gameStateManager, chapterLoader, screenManager);

    // Компоненты
    const StatusBar = {
      props: ['time', 'batteryLevel'],
      template: `
        <div class="status-bar">
          <span class="time">{{ time }}</span>
          <div class="battery-wrapper">
            <div class="battery-indicator">
              <div class="battery-level">
                <div class="battery-fill" :style="{ width: batteryLevel + '%' }"></div>
              </div>
              <div class="battery-cap"></div>
            </div>
            <span class="battery">{{ batteryLevel }}%</span>
            <div class="battery-triangle"></div>
          </div>
        </div>
      `,
    };

    const Navigation = {
      props: ['activeScreen', 'currentLang'],
      emits: ['showScreen', 'toggleLanguage'],
      template: `
        <div class="nav">
          <button class="nav-btn" :class="{ active: activeScreen === 'chat' }" data-screen="chat" @click="$emit('showScreen', 'chat')">Чат</button>
          <button class="nav-btn" :class="{ active: activeScreen === 'puregram' }" data-screen="puregram" @click="$emit('showScreen', 'puregram')">PureGram</button>
          <button class="lang-btn" @click="$emit('toggleLanguage')">{{ currentLang === 'ru' ? 'EN' : 'RU' }}</button>
        </div>
      `,
    };

    const StartScreen = {
      props: ['translations', 'currentLang'],
      emits: ['startNewGame'],
      template: `
        <div class="screen start-screen active">
          <button class="start-game-button" @click="$emit('startNewGame')">
            {{ translations[currentLang]['new-game'] }}
          </button>
        </div>
      `,
    };

    const ChatScreen = {
      props: ['messages', 'choices', 'currentLang', 'showChatList', 'gameState', 'translations', 'currentChat'],
      emits: ['toggleChatList', 'switchChat', 'handleChoice', 'openFullscreenImage'],
      template: `
        <div class="screen chat-screen active">
          <div class="chat-header">
            <button class="chat-list-button" @click="$emit('toggleChatList')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
              </svg>
            </button>
            <div class="chat-info">
              <h2>{{ currentChat.name[currentLang] }}</h2>
              <p class="online-status">{{ translations[currentLang]['online'] }}</p>
            </div>
            <img :src="currentChat.avatar" class="avatar" :alt="currentChat.name[currentLang]">
          </div>
          <div class="chat-list" :class="{ active: showChatList }">
            <div v-for="(chat, id) in gameState.chats" v-if="chat.isActive" class="chat-item" :data-chat-id="id" @click="$emit('switchChat', id)">
              <img :src="chat.avatar" class="avatar" :alt="chat.name[currentLang]">
              <div class="chat-info">
                <h2>{{ chat.name[currentLang] }}</h2>
                <p class="online-status">{{ translations[currentLang]['online'] }}</p>
              </div>
              <div v-if="chat.unread > 0" class="unread-marker"></div>
            </div>
          </div>
          <div class="chat-wrapper">
            <div class="chat-messages" id="chat" ref="chatContainer">
              <div v-for="(message, index) in messages" :key="index" :class="['message', 'message-' + message.type]">
                <div class="message-text" v-if="message.text">{{ message.text[currentLang] || message.text.ru }}</div>
                <img v-if="message.src" :src="message.src" class="chat-image" :alt="message.text?.[currentLang] || 'Message Image'" @click="$emit('openFullscreenImage', message.src)">
                <div class="message-description" v-if="message.description">{{ message.description[currentLang] || message.description.ru }}</div>
              </div>
            </div>
            <div class="choices" id="choices" :class="{ visible: choices.length > 0 }">
              <button v-for="(choice, index) in choices" :key="index" class="choice-button" @click="$emit('handleChoice', choice, index)">
                {{ choice.text[currentLang] || choice.text.ru }}
              </button>
            </div>
          </div>
        </div>
      `,
    };

    const PureGramScreen = {
      props: ['posts', 'currentLang', 'currentChat'],
      emits: ['openFullscreenImage', 'toggleLike'],
      template: `
        <div class="screen puregram active">
          <div class="pg-header">
            <button class="back-btn" @click="$emit('showScreen', 'chat')">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                <path d="M15.41 16.59L10.83 12l4.58-4.59L14 6l-6 6 6 6z"/>
              </svg>
            </button>
            <span>PureGram</span>
          </div>
          <div class="pg-posts">
            <div v-for="(post, index) in posts" :key="index" class="pg-post">
              <div class="pg-post-header">
                <img :src="currentChat.avatar" class="pg-avatar" :alt="currentChat.name[currentLang]">
                <span>{{ currentChat.name[currentLang] }}</span>
              </div>
              <div class="pg-post-image">
                <img :src="post.image" class="post-img" :alt="post.caption[currentLang] || post.caption.ru" @click="$emit('openFullscreenImage', post.image)">
              </div>
              <div class="pg-post-actions">
                <div class="pg-post-like-action">
                  <button class="like-btn" :data-liked="post.liked" @click="$emit('toggleLike', index)">
                    <svg width="24" height="24" :fill="post.liked ? '#ff0055' : '#fff'" viewBox="0 0 16 16">
                      <path d="m8 2.748-.717-.737C5.6.281 2.514.878 1.4 3.053c-.523 1.023-.641 2.5.314 4.385.92 1.815 2.834 3.989 6.286 6.357 3.452-2.368 5.365-4.542 6.286-6.357.955-1.886.838-3.362.314-4.385C13.486.878 10.4.28 8.717 2.01zM8 15C-7.333 4.868 3.279-3.04 7.824 1.143q.09.083.176.171a3 3 0 0 1 .176-.17C12.72-3.042 23.333 4.867 8 15"/>
                    </svg>
                  </button>
                  <span class="pg-post-likes">{{ post.likes }}</span>
                </div>
              </div>
              <div class="pg-post-caption">
                <p>{{ post.caption[currentLang] || post.caption.ru }}</p>
              </div>
            </div>
          </div>
        </div>
      `,
    };

    const BoostyScreen = {
      props: ['translations', 'currentLang'],
      emits: ['startNewGame'],
      template: `
        <div class="screen boosty active">
          <div class="boosty-overlay">
            <p class="boosty-overlay-text">{{ translations[currentLang]['boostyText'] }}</p>
            <button class="boosty-overlay-button" @click="window.open('https://boosty.to', '_blank')">Поддержать на Boosty</button>
            <p class="boosty-overlay-additional-text" @click="$emit('startNewGame')">{{ translations[currentLang]['boostyAdditionalText'] }}</p>
          </div>
        </div>
      `,
    };

    const EndgameScreen = {
      props: ['translations', 'currentLang'],
      emits: ['startSecondArc'],
      template: `
        <div class="screen endgame active">
          <div class="endgame-content">
            <h2>{{ translations[currentLang]['end-chapter'] }}</h2>
            <p>{{ translations[currentLang]['thanks'] }}</p>
            <p>{{ translations[currentLang]['to-be-continued'] }}</p>
            <button class="start-new-chapter" @click="$emit('startSecondArc')">
              {{ translations[currentLang]['new-chapter'] }}
            </button>
          </div>
        </div>
      `,
    };

    // Vue приложение
    const app = createApp({
      components: {
        StatusBar,
        Navigation,
        StartScreen,
        ChatScreen,
        PureGramScreen,
        BoostyScreen,
        EndgameScreen,
      },
      setup() {
        const activeScreen = ref(gameStateManager.loadProgress() ? 'chat' : 'start');
        const messages = ref([]);
        const choices = ref([]);
        const currentLang = ref(languageManager.currentLang);
        const showChatList = ref(false);
        const time = ref('00:00');
        const batteryLevel = ref(88);
        const posts = ref([...gameStateManager.allPosts, ...screenManager.defaultPosts]);

        const gameState = gameStateManager.gameState;
        const translations = languageManager.translations;
        const currentChat = computed(() => gameState.chats[gameState.currentChat] || gameState.chats.lina);

        const toggleLanguage = () => {
          languageManager.toggleLanguage();
          currentLang.value = languageManager.currentLang;
        };

        const startNewGame = () => {
          gameStateManager.startNewGame();
          messageRenderer.clearChat();
          chapterLoader.loadChapter('chapter1', true);
          activeScreen.value = 'chat';
        };

        const startSecondArc = async () => {
          const nextChapter = determineSecondArcStart(gameState);
          if (nextChapter) {
            await chapterLoader.loadChapter(nextChapter);
            activeScreen.value = 'chat';
          }
        };

        const showScreen = (screenId) => {
          activeScreen.value = screenId;
          if (screenId === 'puregram') {
            screenManager.loadPuregramPosts();
            posts.value = [...gameStateManager.allPosts, ...screenManager.defaultPosts];
          }
        };

        const toggleChatList = () => {
          showChatList.value = !showChatList.value;
          if (showChatList.value) {
            choices.value = [];
          }
        };

        const switchChat = (chatId) => {
          gameStateManager.gameState.currentChat = chatId;
          showChatList.value = false;
          chapterLoader.loadChapter(gameState.currentChapter, true);
        };

        const handleChoice = (choice, index) => {
          messageRenderer.addMessage('sent', choice.text);
          gameStateManager.gameState.lastChoiceIndex = index;
          gameStateManager.saveProgress();
          choices.value = [];
          if (choice.result && Array.isArray(choice.result)) {
            renderResult(choice.result);
          } else if (choice.next) {
            chapterLoader.loadChapter(choice.next);
          }
        };

        const renderResult = async (results) => {
          for (const result of results) {
            const text = typeof result.text === 'object' ? result.text[currentLang.value] || result.text.ru : result.text || '';
            const description = typeof result.description === 'object' ? result.description[currentLang.value] || result.description.ru : result.description || '';
            messageRenderer.addMessage(result.type, text, result.src, description);
            await new Promise(resolve => setTimeout(resolve, result.delay || 1500));
            if (result.nextChapter) {
              chapterLoader.loadChapter(result.nextChapter);
            }
          }
        };

        const openFullscreenImage = (src) => {
          const overlay = document.createElement('div');
          overlay.className = 'fullscreen-overlay';
          const img = document.createElement('img');
          img.src = src;
          img.className = 'fullscreen-image';
          const closeBtn = document.createElement('button');
          closeBtn.className = 'fullscreen-close';
          closeBtn.innerHTML = '×';
          closeBtn.addEventListener('click', () => document.body.removeChild(overlay));
          overlay.appendChild(closeBtn);
          overlay.appendChild(img);
          document.body.appendChild(overlay);
          overlay.addEventListener('click', (e) => {
            if (e.target === overlay) document.body.removeChild(overlay);
          });
        };

        const scrollToBottom = () => {
          const chatContainer = document.querySelector('#chat');
          if (chatContainer) {
            chatContainer.scrollTop = chatContainer.scrollHeight;
          }
        };

        const updateClock = () => {
          const now = new Date();
          const hours = String(now.getHours()).padStart(2, '0');
          const minutes = String(now.getMinutes()).padStart(2, '0');
          time.value = `${hours}:${minutes}`;
        };
        updateClock();
        setInterval(updateClock, 60000);

        // Инициализация
        if (gameStateManager.loadProgress()) {
          chapterLoader.loadChapter(gameState.currentChapter, true);
        }

        return {
          activeScreen,
          messages,
          choices,
          currentLang,
          showChatList,
          time,
          batteryLevel,
          gameState,
          translations,
          currentChat,
          posts,
          toggleLanguage,
          startNewGame,
          startSecondArc,
          showScreen,
          toggleChatList,
          switchChat,
          handleChoice,
          openFullscreenImage,
          scrollToBottom,
        };
      },
    });

    app.mount('#app');
  </script>
</body>
</html>